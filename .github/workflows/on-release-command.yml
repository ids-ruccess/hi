# .github/workflows/on-release-command.yml
name: "ğŸš€ Release on Slash-Command"

on:
  issue_comment:
    types: [created]

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      # 1) `/release -v <version> -d \`<description>\`` íŒŒì‹± & ìœ íš¨ì„± ê²€ì‚¬
      - name: Validate & extract `/release` params
        id: validate
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, comment } = context.payload;
            if (!issue.pull_request) return;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });
            if (pr.data.base.ref !== 'main') return;
            const body = comment.body.trim();
            if (!body.startsWith('/release ')) return;
            const vMatch = body.match(/-v\s+(\S+)/);
            if (!vMatch) return;
            const version = vMatch[1];
            const dMatch = body.match(/-d\s+`([\s\S]+?)`/);
            const description = dMatch ? dMatch[1] : '';
            core.setOutput('version', version);
            core.setOutput('description', description);

      # 2) ë²„ì „ í”Œë˜ê·¸ê°€ ì—†ìœ¼ë©´ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ
      - name: Abort if no version
        if: steps.validate.outputs.version == ''
        run: exit 0

      # 3) PRì— â€œì‘ì„±ì¤‘â€ ìƒíƒœ ì½”ë©˜íŠ¸
      - name: Comment â€œì‘ì„±ì¤‘â€ on PR
        if: steps.validate.outputs.version != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‘ì„±ì¤‘â€¦ v${{ steps.validate.outputs.version }}`
            });

      # 4) main ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ (git tag ì¡°ì‘)
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      # 5) Draft Release Notes ìƒì„±
      - name: Draft Release Notes
        id: drafter
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6) ê¸°ì¡´ Draftë¥¼ ì°¾ì•„ í¼ë¸”ë¦¬ì‹œ (ë‹¨ì¼ ë¦´ë¦¬ì¦ˆ ìœ ì§€)
      - name: Publish the existing draft
        id: publish
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = `v${{ steps.validate.outputs.version }}`;
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo:  context.repo.repo
            });
            const draft = releases.find(r => r.tag_name === tag && r.draft);
            if (!draft) throw new Error(`Draft for ${tag} not found`);
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              release_id: draft.id,
              draft: false
            });

      # 7) ì„±ê³µ ì½”ë©˜íŠ¸
      - name: Comment success on PR
        if: steps.publish.conclusion == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… ë¦´ë¦¬ì¦ˆ v${{ steps.validate.outputs.version }} ì‘ì„± ì™„ë£Œ!`
            });

      # 8) ì‹¤íŒ¨ ì‹œ íƒœê·¸ ì‚­ì œ í›„ ì½”ë©˜íŠ¸
      - name: Cleanup tag & comment failure
        if: steps.publish.conclusion != 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/v${{ steps.validate.outputs.version }}`
              });
            } catch {}
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âŒ ë¦´ë¦¬ì¦ˆ v${{ steps.validate.outputs.version }} ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
            });
