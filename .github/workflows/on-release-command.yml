# .github/workflows/on-release-command.yml
name: "ğŸš€ Release on Slash-Command"

on:
  issue_comment:
    types: [created]

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}

    steps:
      # 1) PRì¸ì§€Â·baseê°€ mainì¸ì§€Â·ëª…ë ¹ì–´ íŒŒì‹±
      - name: Validate & extract `/release` params
        id: validate
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, comment } = context.payload;
            // PR ì—¬ë¶€
            if (!issue.pull_request) return;
            // PR ìƒì„¸
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });
            if (pr.data.base.ref !== "main") return;
            const body = comment.body.trim();
            if (!body.startsWith("/release ")) return;
            // -v ë²„ì „
            const vMatch = body.match(/-v\s+(\S+)/);
            if (!vMatch) return;
            const version = vMatch[1];
            // -d ì„¤ëª… (ë°±í‹± ë‚´ë¶€)
            const dMatch = body.match(/-d\s+`([\s\S]+?)`/);
            const description = dMatch ? dMatch[1] : "";
            core.setOutput("version", version);
            core.setOutput("description", description);

      # 2) versionì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
      - name: Abort if no version
        if: steps.validate.outputs.version == ''
        run: exit 0

      # 3) ë¦´ë¦¬ì¦ˆ ì¤€ë¹„ì¤‘ ì½”ë©˜íŠ¸
      - name: Comment â€œì‘ì„±ì¤‘â€ on PR
        if: steps.validate.outputs.version != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‘ì„±ì¤‘ì…ë‹ˆë‹¤â€¦\nv${{ steps.validate.outputs.version }}`
            });

      # 4) ì½”ë“œ ì²´í¬ì•„ì›ƒ (git tag, delete tag ìš©)
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      # 5) íƒœê·¸ ìƒì„± & í‘¸ì‹œ (ì˜¤ë¥˜ ë‚˜ë„ ê³„ì†)
      - name: Create Tag & Push
        id: push_tag
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag "v${{ steps.validate.outputs.version }}"
          git push origin "v${{ steps.validate.outputs.version }}"

      # 6) Draft Release Notes (continue-on-error)
      - name: Draft Release Notes
        id: drafter
        continue-on-error: true
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7) Publish Release (continue-on-error)
      - name: Publish Release
        id: publish_release
        continue-on-error: true
        uses: actions/create-release@v1
        with:
          tag_name: "v${{ steps.validate.outputs.version }}"
          release_name: "v${{ steps.validate.outputs.version }}"
          draft: false
          body: |
            ${{ steps.validate.outputs.description }}

            ${{ steps.drafter.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8) ì„±ê³µ ì½”ë©˜íŠ¸
      - name: Comment Success on PR
        if: steps.validate.outputs.version != '' && steps.publish_release.outcome == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… ë¦´ë¦¬ì¦ˆ v${{ steps.validate.outputs.version }} ì‘ì„± ì™„ë£Œ!`
            });

      # 9) ì‹¤íŒ¨ ì½”ë©˜íŠ¸ & íƒœê·¸ ì‚­ì œ
      - name: Comment Failure & Cleanup Tag
        if: steps.validate.outputs.version != '' && steps.publish_release.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # íƒœê·¸ ì‚­ì œ ì‹œë„
          git push origin --delete "v${{ steps.validate.outputs.version }}" || true
        shell: bash
      - name: Post Failure Comment
        if: steps.validate.outputs.version != '' && steps.publish_release.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âŒ ë¦´ë¦¬ì¦ˆ v${{ steps.validate.outputs.version }} ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
            });
