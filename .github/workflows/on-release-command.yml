# .github/workflows/on-release-command.yml
name: "ğŸš€ Release on Slash-Command"

on:
  issue_comment:
    types: [created]

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      # 1) /release -v <ver> -d `<desc>` íŒŒì‹± & base ë¸Œëœì¹˜ ì¶”ì¶œ
      - name: Validate & extract `/release` params
        id: validate
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, comment } = context.payload;
            if (!issue.pull_request) return;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              pull_number: issue.number
            });
            const base = pr.data.base.ref;
            // base ë¸Œëœì¹˜ê°€ mainì´ ì•„ë‹ ê²½ìš° ìŠ¤í‚µ
            if (base !== 'main') return;
            const b = comment.body.trim();
            if (!b.startsWith('/release ')) return;
            const vm = b.match(/-v\s+(\S+)/);
            if (!vm) return;
            const version = vm[1];
            const dm = b.match(/-d\s+`([\s\S]+?)`/);
            const description = dm ? dm[1] : '';
            core.setOutput('version', version);
            core.setOutput('description', description);
            core.setOutput('base_branch', base);

      # 2) versionì´ ì—†ìœ¼ë©´ ì¢…ë£Œ (base â‰  mainë„ ì—¬ê¸°ì„œ ì¡í˜)
      - name: Abort if no version
        if: steps.validate.outputs.version == ''
        run: exit 0

      # 3) â€œì‘ì„±ì¤‘â€ ì½”ë©˜íŠ¸
      - name: Comment â€œì‘ì„±ì¤‘â€ on PR
        if: steps.validate.outputs.version != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‘ì„±ì¤‘â€¦ v${{ steps.validate.outputs.version }}`
            });

      # 4) PRì˜ base ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
      - name: Checkout base branch
        if: steps.validate.outputs.version != ''
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.validate.outputs.base_branch }}

      # 5) íƒœê·¸ ìƒì„± & í‘¸ì‹œ
      - name: Create Tag & Push
        if: steps.validate.outputs.version != ''
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag "v${{ steps.validate.outputs.version }}"
          git push origin "v${{ steps.validate.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6) Draft ìƒì„±/ì—…ë°ì´íŠ¸
      - name: Draft Release Notes
        id: drafter
        if: steps.validate.outputs.version != ''
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release.yml
          version: ${{ steps.validate.outputs.version }}
          name: "Release v${{ steps.validate.outputs.version }}"
          tag:  "v${{ steps.validate.outputs.version }}"
          header: ${{ steps.validate.outputs.description }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7) Draft í¼ë¸”ë¦¬ì‹œ (ë‹¨ì¼ ë¦´ë¦¬ì¦ˆ ìœ ì§€)
      - name: Publish the draft
        id: publish
        if: steps.drafter.outputs.id != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseId = parseInt('${{ steps.drafter.outputs.id }}', 10);
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              draft: false
            });

      # 8) ì„±ê³µ ì½”ë©˜íŠ¸
      - name: Comment success on PR
        if: steps.publish.outcome == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… Release v${{ steps.validate.outputs.version }} ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`
            });

      # 8-1) Slack ì•Œë¦¼ (Release ì„±ê³µ)
      - name: Notify Slack on Release Success
        if: steps.publish.outcome == 'success'
        uses: actions/github-script@v6
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          script: |
            const version = '${{ steps.validate.outputs.version }}';
            const description = '${{ steps.validate.outputs.description }}';
            const releaseUrl = `https://github.com/${{ github.repository }}/releases/tag/v${version}`;
            const repoUrl = `https://github.com/${{ github.repository }}`;
            const commitSha = '${{ github.sha }}';
            const commitShort = commitSha.substring(0, 7);
            const commitUrl = `${repoUrl}/commit/${commitSha}`;
            const branch = '${{ steps.validate.outputs.base_branch }}';
            const actor = '${{ github.actor }}';

            // KST ì‹œê°„ ìƒì„±
            const now = new Date();
            const kstOffset = 9 * 60; // KSTëŠ” UTC+9
            const kstTime = new Date(now.getTime() + kstOffset * 60 * 1000);
            const timestamp = kstTime.toISOString().replace('T', ' ').substring(0, 19) + ' GMT+0900 (KST)';

            const blocks = [
              { type: "divider" },
              {
                type: "section",
                fields: [
                  { type: "mrkdwn", text: `*í”„ë¡œì íŠ¸*\n*<${repoUrl}|${{ github.repository }}>*` },
                ]
              },
              {
                type: "section",
                fields: [
                  { type: "mrkdwn", text: `*ë²„ì „*\n\`v${version}\`` },
                  { type: "mrkdwn", text: `*ë¸Œëœì¹˜*\n\`${branch}\`` }
                ]
              },
              {
                type: "section",
                fields: [
                  { type: "mrkdwn", text: `*ì»¤ë°‹*\n<${commitUrl}|${commitShort}>` },
                  { type: "mrkdwn", text: `*Release*\n<${releaseUrl}|View Release>` }
                ]
              },
              {
                type: "section",
                fields: [
                  { type: "mrkdwn", text: `*ì‘ì„±ì*\n\`${actor}\`` },
                  { type: "mrkdwn", text: `*ìƒíƒœ*\nâœ… \`SUCCESS\`` }
                ]
              },
              { type: "divider" }
            ];

            if (description && description.trim()) {
              blocks.push({
                type: "section",
                text: { type: "mrkdwn", text: `*ì„¤ëª…*\n${description.trim()}` }
              });
              blocks.push({ type: "divider" });
            }

            blocks.push({
              type: "context",
              elements: [
                { type: "mrkdwn", text: timestamp }
              ]
            });

            const payload = { blocks };

            const webhook = process.env.SLACK_WEBHOOK_URL;
            if (!webhook) {
              console.log('SLACK_WEBHOOK_URL is not set. Skipping Slack notification.');
              return;
            }

            const response = await fetch(webhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              throw new Error(`Slack notification failed: ${response.statusText}`);
            }
            console.log('Slack notification sent successfully');

      # 9) ì‹¤íŒ¨ ì‹œ íƒœê·¸ ì‚­ì œ & ì‹¤íŒ¨ ì½”ë©˜íŠ¸
      - name: Cleanup Tag & Comment Failure
        if: steps.publish.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/v${{ steps.validate.outputs.version }}`
              });
            } catch {}
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âŒ Release v${{ steps.validate.outputs.version }} ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`
            });
